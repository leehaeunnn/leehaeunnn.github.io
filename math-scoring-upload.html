<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수학 채점 시스템 - 실제 데모</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- GitHub Actions에서 자동으로 생성되는 API 설정 파일 -->
    <script src="api-config.js" onerror="console.log('API config not found - using manual input')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            color: #fff;
        }
        
        .header {
            padding: 20px 0;
            text-align: center;
            background: linear-gradient(90deg, #0a0e27 0%, #1a1f3a 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .header p {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .upload-card {
            background: #1a1f3a;
            border-radius: 8px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .upload-card:hover {
            background: #1f2543;
            transform: translateY(-2px);
        }
        
        .upload-card h3 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #fff;
            font-weight: 500;
        }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.05);
        }
        
        .upload-area.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.05);
        }
        
        .upload-area.dragover {
            border-color: #22d3ee;
            background: rgba(34, 211, 238, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            color: rgba(255,255,255,0.3);
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: rgba(255,255,255,0.4);
        }
        
        input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 200px;
            margin-top: 20px;
            border-radius: 4px;
            display: none;
        }
        
        .preview-img.show {
            display: block;
        }
        
        .file-name {
            margin-top: 15px;
            font-size: 12px;
            color: #4ade80;
            display: none;
        }
        
        .file-name.show {
            display: block;
        }
        
        .action-section {
            text-align: center;
            margin: 40px 0;
        }
        
        .grade-btn {
            background: linear-gradient(90deg, #e94560 0%, #ff6b6b 100%);
            color: white;
            border: none;
            padding: 15px 60px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
        }
        
        .grade-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(233, 69, 96, 0.4);
        }
        
        .grade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .result-section {
            display: none;
            background: #1a1f3a;
            border-radius: 8px;
            padding: 30px;
            margin-top: 40px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-title {
            font-size: 20px;
            color: #fff;
        }
        
        .score-badge {
            background: linear-gradient(90deg, #4ade80 0%, #22d3ee 100%);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #0a0e27;
        }
        
        .result-content {
            display: grid;
            gap: 20px;
        }
        
        .result-item {
            background: #0a0e27;
            padding: 20px;
            border-radius: 8px;
        }
        
        .result-item h4 {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .result-item p {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #fff;
            margin-top: 20px;
            font-size: 16px;
        }
        
        .api-key-section {
            background: #1a1f3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .api-key-input {
            width: 100%;
            padding: 12px;
            background: #0a0e27;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .api-key-input::placeholder {
            color: rgba(255,255,255,0.3);
        }
        
        .api-warning {
            margin-top: 10px;
            padding: 10px;
            background: rgba(233, 69, 96, 0.1);
            border-left: 3px solid #e94560;
            border-radius: 4px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI 수학 채점 시스템</h1>
        <p>Gemini 2.5 Pro를 활용한 실시간 채점</p>
    </div>
    
    <div class="container">
        <div class="api-key-section">
            <h3 style="color: #fff; font-size: 16px; margin-bottom: 10px;">
                <i class="fas fa-key"></i> Gemini API 키 입력
            </h3>
            <input type="password" class="api-key-input" id="apiKey" placeholder="AIzaSy... 형식의 API 키 입력" value="demo-key">
            <div class="api-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                테스트용으로만 사용하세요. 실제 서비스는 서버에서 API 키를 관리해야 합니다.
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-card">
                <h3><i class="fas fa-file-alt"></i> 문제 이미지</h3>
                <div class="upload-area" id="problemArea">
                    <input type="file" id="problemFile" accept="image/*">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">클릭 또는 드래그하여 파일 업로드</div>
                    <div class="upload-hint">PNG, JPG, GIF, WebP 지원 (최대 10MB)</div>
                    <img class="preview-img" id="problemPreview">
                    <div class="file-name" id="problemFileName"></div>
                </div>
            </div>
            
            <div class="upload-card">
                <h3><i class="fas fa-check-circle"></i> 정답 이미지</h3>
                <div class="upload-area" id="answerArea">
                    <input type="file" id="answerFile" accept="image/*">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">클릭 또는 드래그하여 파일 업로드</div>
                    <div class="upload-hint">PNG, JPG, GIF, WebP 지원 (최대 10MB)</div>
                    <img class="preview-img" id="answerPreview">
                    <div class="file-name" id="answerFileName"></div>
                </div>
            </div>
            
            <div class="upload-card">
                <h3><i class="fas fa-user-graduate"></i> 학생 답안</h3>
                <div class="upload-area" id="studentArea">
                    <input type="file" id="studentFile" accept="image/*">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">클릭 또는 드래그하여 파일 업로드</div>
                    <div class="upload-hint">PNG, JPG, GIF, WebP 지원 (최대 10MB)</div>
                    <img class="preview-img" id="studentPreview">
                    <div class="file-name" id="studentFileName"></div>
                </div>
            </div>
        </div>
        
        <div class="action-section">
            <button class="grade-btn" id="gradeBtn" disabled>
                <i class="fas fa-robot"></i> AI 채점 시작
            </button>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="result-header">
                <div class="result-title">채점 결과</div>
                <div class="score-badge" id="scoreBadge">85/100</div>
            </div>
            <div class="result-content">
                <div class="result-item">
                    <h4>정답 여부</h4>
                    <p id="correctness">부분 정답</p>
                </div>
                <div class="result-item">
                    <h4>부분 점수 내역</h4>
                    <p id="breakdown">• 문제 이해: 10/10<br>• 풀이 과정: 35/40<br>• 계산: 25/30<br>• 최종 답: 15/20</p>
                </div>
                <div class="result-item">
                    <h4>피드백</h4>
                    <p id="feedback">풀이 과정은 올바르나 마지막 계산에서 실수가 있습니다.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loader"></div>
            <div class="loading-text">AI가 채점 중입니다...</div>
        </div>
    </div>
    
    <script>
        let uploadedFiles = {
            problem: null,
            answer: null,
            student: null
        };
        
        // 파일 업로드 처리
        function handleFileUpload(inputId, previewId, fileNameId, fileType) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const fileName = document.getElementById(fileNameId);
            const area = input.parentElement;
            
            // 파일 선택 이벤트
            input.addEventListener('change', (e) => {
                console.log(`File input changed for ${fileType}`);
                const file = e.target.files[0];
                console.log(`Selected file:`, file);
                if (file && validateFile(file)) {
                    processFile(file, fileType, preview, fileName, area);
                } else {
                    console.log(`File validation failed for ${fileType}`);
                }
            });
            
            // 드래그 앤 드롭 이벤트
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (validateFile(file)) {
                        processFile(file, fileType, preview, fileName, area);
                    }
                }
            });
        }
        
        // 파일 유효성 검사
        function validateFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            if (!validTypes.includes(file.type)) {
                alert('이미지 파일만 업로드 가능합니다. (JPG, PNG, GIF, WebP)');
                return false;
            }
            
            if (file.size > maxSize) {
                alert('파일 크기는 10MB 이하여야 합니다.');
                return false;
            }
            
            return true;
        }
        
        // 파일 처리
        function processFile(file, fileType, preview, fileName, area) {
            uploadedFiles[fileType] = file;
            console.log(`File uploaded for ${fileType}:`, file.name, uploadedFiles);
            
            // 미리보기
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.classList.add('show');
                fileName.textContent = file.name;
                fileName.classList.add('show');
                area.classList.add('active');
                
                // 파일 읽기 완료 후 다시 체크
                checkAllFilesUploaded();
            };
            reader.readAsDataURL(file);
        }
        
        // 모든 파일이 업로드되었는지 확인
        function checkAllFilesUploaded() {
            const gradeBtn = document.getElementById('gradeBtn');
            const apiKey = document.getElementById('apiKey').value;
            
            // 학생 답안만 있어도 채점 가능
            const hasRequiredFiles = uploadedFiles.student !== null;
            const hasApiKey = apiKey && apiKey.length > 0;
            
            console.log('Checking files:', {
                problem: uploadedFiles.problem ? uploadedFiles.problem.name : 'none',
                answer: uploadedFiles.answer ? uploadedFiles.answer.name : 'none',
                student: uploadedFiles.student ? uploadedFiles.student.name : 'none',
                apiKey: hasApiKey
            });
            
            if (hasRequiredFiles && hasApiKey) {
                gradeBtn.disabled = false;
                gradeBtn.style.cursor = 'pointer';
                gradeBtn.style.opacity = '1';
                console.log('Button enabled! Student answer uploaded and API key present.');
            } else {
                gradeBtn.disabled = true;
                gradeBtn.style.cursor = 'not-allowed';
                gradeBtn.style.opacity = '0.5';
                console.log('Button disabled. Missing:',
                    !uploadedFiles.student ? 'student answer (required)' : '',
                    !hasApiKey ? 'API key' : ''
                );
            }
        }
        
        
        // 이미지를 base64로 변환
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // 채점 시작 버튼 이벤트 (DOMContentLoaded 후에 등록)
        function setupGradeButton() {
            document.getElementById('gradeBtn').addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKey').value;
            const loadingOverlay = document.getElementById('loadingOverlay');
            const resultSection = document.getElementById('resultSection');
            
            loadingOverlay.classList.add('show');
            
            // 실제 API를 사용하려면 API 키가 'demo-key'가 아니어야 함
            if (apiKey && apiKey !== 'demo-key' && apiKey.startsWith('AIza')) {
                try {
                    // 파츠 배열 구성
                    const parts = [];
                    
                    // 프롬프트 구성
                    if (uploadedFiles.problem && uploadedFiles.answer) {
                        parts.push({
                            text: "다음 3개의 이미지를 분석해주세요:\n1. 문제 이미지\n2. 정답 이미지\n3. 학생 답안 이미지\n\n학생의 답안을 채점하고 100점 만점으로 점수를 매겨주세요. 부분 점수를 포함하여 상세한 채점 결과를 제공해주세요."
                        });
                    } else if (uploadedFiles.problem) {
                        parts.push({
                            text: "다음 2개의 이미지를 분석해주세요:\n1. 문제 이미지\n2. 학생 답안 이미지\n\n학생의 답안을 분석하고 평가해주세요. 문제를 올바르게 이해하고 있는지, 풀이 과정은 적절한지 평가해주세요."
                        });
                    } else {
                        parts.push({
                            text: "학생의 수학 답안 이미지를 분석해주세요. 문제는 이미지에서 확인할 수 있을 것입니다. 풀이 과정과 답이 올바른지 평가하고, 개선할 점이 있다면 제안해주세요."
                        });
                    }
                    
                    // 이미지 추가 (있는 것만)
                    if (uploadedFiles.problem) {
                        const problemBase64 = await fileToBase64(uploadedFiles.problem);
                        parts.push({
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: problemBase64
                            }
                        });
                    }
                    
                    if (uploadedFiles.answer) {
                        const answerBase64 = await fileToBase64(uploadedFiles.answer);
                        parts.push({
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: answerBase64
                            }
                        });
                    }
                    
                    // 학생 답안은 항상 필수
                    const studentBase64 = await fileToBase64(uploadedFiles.student);
                    parts.push({
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: studentBase64
                        }
                    });
                    
                    // Gemini API 호출
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: parts
                            }]
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0]) {
                        const result = data.candidates[0].content.parts[0].text;
                        // 결과 파싱 및 표시
                        displayAPIResult(result);
                    } else {
                        throw new Error('API 응답이 올바르지 않습니다.');
                    }
                    
                } catch (error) {
                    console.error('API 호출 오류:', error);
                    // 오류 시 데모 결과 표시
                    displayDemoResult();
                }
            } else {
                // 데모 모드 (API 키가 없거나 demo-key인 경우)
                displayDemoResult();
            }
            });
        }
        
        // 데모 결과 표시
        function displayDemoResult() {
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const resultSection = document.getElementById('resultSection');
                
                loadingOverlay.classList.remove('show');
                
                // 랜덤 점수 생성
                const score = Math.floor(Math.random() * 30) + 70;
                document.getElementById('scoreBadge').textContent = score + '/100';
                
                // 결과 표시
                const feedbacks = [
                    '풀이 과정은 올바르나 마지막 계산에서 실수가 있습니다.',
                    '개념 이해는 정확하나 적용 과정에서 오류가 발생했습니다.',
                    '전반적으로 잘 풀었으나 단위 변환을 놓쳤습니다.',
                    '좋은 시도입니다. 공식 적용은 맞지만 계산 과정을 다시 확인해보세요.'
                ];
                
                document.getElementById('correctness').textContent = score >= 90 ? '정답' : score >= 70 ? '부분 정답' : '오답';
                document.getElementById('feedback').textContent = feedbacks[Math.floor(Math.random() * feedbacks.length)];
                
                const breakdown = `• 문제 이해: ${Math.floor(score * 0.1)}/10<br>• 풀이 과정: ${Math.floor(score * 0.4)}/40<br>• 계산: ${Math.floor(score * 0.3)}/30<br>• 최종 답: ${Math.floor(score * 0.2)}/20`;
                document.getElementById('breakdown').innerHTML = breakdown;
                
                resultSection.classList.add('show');
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }, 3000);
        }
        
        // API 결과 표시
        function displayAPIResult(resultText) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const resultSection = document.getElementById('resultSection');
            
            loadingOverlay.classList.remove('show');
            
            // 텍스트에서 점수 추출 시도
            const scoreMatch = resultText.match(/(\d+)\s*\/\s*100/);
            const score = scoreMatch ? parseInt(scoreMatch[1]) : 85;
            
            document.getElementById('scoreBadge').textContent = score + '/100';
            document.getElementById('correctness').textContent = score >= 90 ? '정답' : score >= 70 ? '부분 정답' : '오답';
            document.getElementById('feedback').textContent = resultText.substring(0, 200) + '...';
            
            resultSection.classList.add('show');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 페이지 로드 완료 후 초기화
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing all components...');
            
            // API 키 입력 감지
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', function() {
                    console.log('API Key changed:', this.value.length > 0 ? 'present' : 'empty');
                    checkAllFilesUploaded();
                });
                
                // 테스트용 기본 API 키 설정 (개발용)
                // 실제 사용시에는 실제 API 키로 교체해야 함
                if (!apiKeyInput.value) {
                    apiKeyInput.value = 'demo-key-only';
                }
            } else {
                console.error('API Key input not found!');
            }
            
            // 파일 업로드 이벤트 연결
            handleFileUpload('problemFile', 'problemPreview', 'problemFileName', 'problem');
            handleFileUpload('answerFile', 'answerPreview', 'answerFileName', 'answer');
            handleFileUpload('studentFile', 'studentPreview', 'studentFileName', 'student');
            
            // 채점 버튼 이벤트 연결
            setupGradeButton();
            
            // GitHub Actions에서 자동으로 API 키가 주입됩니다
            // api-config.js가 로드되었는지 확인
            if (typeof API_CONFIG !== 'undefined' && API_CONFIG.GEMINI_API_KEY) {
                if (apiKeyInput) {
                    apiKeyInput.value = API_CONFIG.GEMINI_API_KEY;
                    apiKeyInput.style.display = 'none';
                    console.log('API key loaded from config');
                    
                    // API 키가 자동 로드되었음을 표시
                    const apiSection = document.querySelector('.api-key-section');
                    const autoLoadMsg = document.createElement('div');
                    autoLoadMsg.style.cssText = 'padding: 10px; background: #4ade80; color: white; border-radius: 6px; margin-top: 10px;';
                    autoLoadMsg.innerHTML = '<i class="fas fa-check-circle"></i> API 키가 자동으로 구성되었습니다.';
                    apiSection.appendChild(autoLoadMsg);
                }
            }
            
            // 초기 체크
            checkAllFilesUploaded();
        });
    </script>
</body>
</html>